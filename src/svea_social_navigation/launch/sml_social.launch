<?xml version="1.0"?>
<launch>

    <!-- Launch file arguments -->
    <!-- SET DEBUG TO TRUE AT YOUR OWN 'COMPUTATIONALLY DEMANDING' RISK -->
    <arg name="debug" default="True"/>
    <arg name="map" default="sml_planner"/>
    <arg name="local_costmap_topic" default="/costmap_node/costmap/costmap"/>
    <arg name="waypoint_topic" default="/target"/>
    <arg name="dynamic_obstacle_topic" default="/dynamic_obstacles"/>
    <arg name="static_unmapped_obstacle_topic" default="/static_unmapped_obstacles"/>
    <arg name="is_mocap" default="true"/>
    <arg name="svea_name" default="svea2"/>
    <arg name="is_sim" default="true"/>
    <arg name="use_rviz" default="true"/>
    <arg name="remote_rviz" default="false"/>
    <arg name="obstacle_map" default="sml_planner_obstacles"/>
    <arg name="initial_pose_x" default="-2.65488696"/>
    <arg name="initial_pose_y" default="-1.64422277"/>
    <arg name="initial_pose_a" default="1.57" />
    <!-- wrt to map-->

    <!-- Real world stuff -->
    <arg name="xavier" default="false"/>
    <arg name="lidar_ip"    default="192.168.3.11" />

    <!-- Start map server -->
    <node name="map_server" pkg="map_server" type="map_server" args="$(find svea_core)/maps/$(arg map).yaml" output="screen"/>

    <rosparam command="load" file="$(find svea_core)/params/$(arg obstacle_map).yaml" />

    <!-- If is_sim equal to false, then include all these tags-->
    <group unless="$(arg is_sim)">

        <!-- Start low-level interface -->
        <node name="serial_node" pkg="rosserial_python" type="serial_node.py">
            <param name="port" value="/dev/ttyACM0"/>
            <param name="baud" value="250000"/>
        </node>

        <!-- Hokuyo LIDAR -->
        <node pkg="urg_node" type="urg_node" name="Hokyoulidar">
            <param name="ip_address"        value="$(arg lidar_ip)" />
            <param name="frame_id"          value="laser"/>
            <param name="calibrate_time"    value="true"/>
            <param name="publish_intensity" value="true"/>
            <param name="publish_multiecho" value="false"/>
            <param name="angle_min"         value="-2.355"/>
            <param name="angle_max"         value="2.355"/>
        </node>

        <group if="$(arg is_mocap)">
            <include file="$(find svea_sensors)/launch/transforms.launch">
                <arg name="xavier" value="$(arg xavier)"/>
            </include>
        </group>

        <group unless="$(arg is_mocap)">
            <!-- Start localization -->
            <include file="$(find svea_sensors)/launch/localize.launch">
                <arg name="initial_pose_x" value="$(arg initial_pose_x)" />
                <arg name="initial_pose_y" value="$(arg initial_pose_y)" />
                <arg name="initial_pose_a" value="$(arg initial_pose_a)" />
            </include>
        </group>
    </group>

    <!-- Start RViz -->
    <node if="$(eval use_rviz and not remote_rviz)" name="rviz" pkg="rviz" type="rviz" args="-d $(find svea_social_navigation)/rviz/config.rviz"/>
    <!-- Start pure_pursuit -->
    <node name="svea_social_navigation" pkg="svea_social_navigation" type="social_navigation.py" output="screen">
        <param name="use_rviz" value="$(arg use_rviz)"/>
        <param name="is_sim" value="$(arg is_sim)"/>
        <param name="remote_rviz" value="$(arg remote_rviz)" />
        <rosparam>
            state: [7.6, 2.9, 1.57, 0] # initial state (x, y, yaw)
            goal: [7.6, 6.8]
            static_unmapped_obstacles: []
            dynamic_obstacles: [[7.3, 5.7, 0.3, 0, 7.3, 8, 3.5, 5.7]] # (x, y, v, theta, x_lb, x_ub, y_lb, y_ub)
        </rosparam>
    </node>

    <!-- Run the costmap node -->
    <group if="$(arg is_sim)">
        <node name="tf_sim_lidar_to_base_link" pkg="tf" type="static_transform_publisher" args="0.30 0 0.22 0 0 0 $(arg
        svea_name)/base_link $(arg svea_name)/sim_lidar 100" />
        <node name="static_unmapped_obstacle_simulator" pkg="svea_social_navigation" type="static_unmapped_obstacle_simulator.py" />
        <node name="costmap_node" pkg="costmap_2d" type="costmap_2d_node">
            <rosparam file="$(find svea_social_navigation)/config/costmap_params_sim.yaml" command="load" ns="costmap" />
        </node>
    </group>
    <group unless="$(arg is_sim)">
        <node name="tf_lidar_to_base_link" pkg="tf" type="static_transform_publisher" args="0 0 -0.175 0 0 0 $(arg svea_name) base_link 100" />
        <node name="tf_odom_to_base_link" pkg="tf" type="static_transform_publisher" args="0 0 0 0 0 0 base_link odom 100" />
        <node name="static_unmapped_obstacle_simulator" pkg="svea_social_navigation" type="static_unmapped_obstacle_simulator.py" />
        <node name="costmap_node" pkg="costmap_2d" type="costmap_2d_node">
            <rosparam file="$(find svea_social_navigation)/config/costmap_params_svea.yaml" command="load" ns="costmap" />
        </node>
    </group>
    <!--
        state: [2.8, 3.1, 0.7853981633974483, 0] # initial state (x, y, yaw)
            goal: [7.5, 7.5]
        state: [5.5, 3.85, 1.57, 0] # initial state (x, y, yaw)
            goal: [6.3, 8]

        state: [7.6, 2.9, 1.57, 0] # initial state (x, y, yaw)
            goal: [7.6, 6.8]

        static_unmapped_obstacles: [[7, 5.6], [7.2, 5]]
        dynamic_obstacles: [[5.3, 3.7, 0.3, 0, 5, 6, 3, 5], [5.3, 4.7, 0.3, 0, 5, 6, 3, 5], [8, 1.6, 0.3, 1.57, 7, 9, 1, 2]]
    -->

    <!-- Pedestrian Simulator -->
    <group if="$(arg is_sim)">
        <include file="$(find svea_social_navigation)/launch/pedsim.launch"/>
    </group>
</launch>